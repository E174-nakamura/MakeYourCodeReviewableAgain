<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promise Flow Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .input-panel,
        .output-panel {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #404040;
        }

        .input-panel {
            display: flex;
            flex-direction: column;
        }

        h2 {
            margin-top: 0;
            color: #4a9eff;
            border-bottom: 2px solid #4a9eff;
            padding-bottom: 10px;
        }

        textarea {
            flex: 1;
            background: #1a1a1a;
            color: #e0e0e0;
            border: 1px solid #404040;
            border-radius: 4px;
            padding: 15px;
            font-family: inherit;
            font-size: 14px;
            resize: none;
            outline: none;
        }

        textarea:focus {
            border-color: #4a9eff;
        }

        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 15px;
            transition: background 0.2s;
        }

        button:hover {
            background: #357abd;
        }

        .analysis-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 4px;
            border: 1px solid #404040;
        }

        .analysis-section h3 {
            margin-top: 0;
            color: #ffa500;
        }

        .warning {
            background: #4a2c00;
            border-left: 4px solid #ffa500;
            padding: 10px;
            margin: 10px 0;
        }

        .suggestion {
            background: #003d4a;
            border-left: 4px solid #00bcd4;
            padding: 10px;
            margin: 10px 0;
        }

        .mermaid {
            background: white;
            border-radius: 4px;
            padding: 20px;
            margin: 15px 0;
        }

        .examples {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .example-btn {
            background: #404040;
            padding: 8px 12px;
            font-size: 12px;
        }

        .example-btn:hover {
            background: #505050;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="input-panel">
            <h2>ğŸ“ JavaScript/TypeScript Code</h2>
            <div class="examples">
                <button class="example-btn" onclick="loadExample(1)">Basic</button>
                <button class="example-btn" onclick="loadExample(2)">Parallel</button>
                <button class="example-btn" onclick="loadExample(3)">Complex</button>
                <button class="example-btn" onclick="loadExample(4)" style="background: #d32f2f;">âŒ Bad 1</button>
                <button class="example-btn" onclick="loadExample(5)" style="background: #d32f2f;">âŒ Bad 2</button>
                <button class="example-btn" onclick="loadExample(6)" style="background: #2e7d32;">âœ… Good</button>
                <button class="example-btn" onclick="loadExample(7)" style="background: #d32f2f;">âŒ Hell</button>
                <button class="example-btn" onclick="loadExample(8)" style="background: #d32f2f;">âŒ Mixed</button>
            </div>
            <textarea id="codeInput" placeholder="async function example() {
  const data = await fetch('/api/data');
  const result = await data.json();
  return result;
}">async function fetchUserData(userId) {
  try {
    const user = await fetch(`/api/users/${userId}`);
    const userData = await user.json();
    
    const posts = await fetch(`/api/users/${userId}/posts`);
    const postsData = await posts.json();
    
    return { user: userData, posts: postsData };
  } catch (error) {
    console.error('Error:', error);
    throw error;
  }
}</textarea>
            <button onclick="analyzeCode()">ğŸ” Analyze Promise Flow</button>
        </div>

        <div class="output-panel">
            <h2>ğŸ“Š Promise Flow Analysis</h2>

            <div class="analysis-section" id="issues">
                <h3>âš ï¸ Issues & Suggestions</h3>
                <div id="issuesContent">åˆ†æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
            </div>

            <div class="analysis-section" id="metrics">
                <h3>ğŸ“ˆ Code Metrics</h3>
                <div id="metricsContent"></div>
            </div>

            <div class="analysis-section">
                <h3>ğŸ—ºï¸ Promise Flow Diagram</h3>
                <div id="flowDiagram"></div>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: false,
            theme: 'base',
            themeVariables: {
                primaryColor: '#4a9eff',
                primaryTextColor: '#000',
                primaryBorderColor: '#357abd',
                lineColor: '#666',
                secondaryColor: '#ffa500',
                tertiaryColor: '#e0e0e0'
            }
        });

        const examples = {
            1: `async function fetchUserData(userId) {
  try {
    const user = await fetch(\`/api/users/\${userId}\`);
    const userData = await user.json();
    
    const posts = await fetch(\`/api/users/\${userId}/posts\`);
    const postsData = await posts.json();
    
    return { user: userData, posts: postsData };
  } catch (error) {
    console.error('Error:', error);
    throw error;
  }
}`,
            2: `async function processData() {
  const data1 = fetch('/api/data1');
  const data2 = fetch('/api/data2');
  const data3 = fetch('/api/data3');
  
  const result1 = await data1.json();
  const result2 = await data2.json();
  const result3 = await data3.json();
  
  return [result1, result2, result3];
}`,
            3: `async function complexFlow(id) {
  const config = await getConfig();
  
  if (config.useCache) {
    const cached = await getFromCache(id);
    if (cached) return cached;
  }
  
  const [userData, preferences] = await Promise.all([
    fetchUser(id),
    fetchPreferences(id)
  ]);
  
  const enrichedData = await enrichUserData(userData, preferences);
  
  if (config.useCache) {
    await saveToCache(id, enrichedData);
  }
  
  return enrichedData;
}`,
            // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ç”¨ã®è¿½åŠ ä¾‹
            4: `// âŒ BAD: å…¸å‹çš„ãªAIç”Ÿæˆã‚³ãƒ¼ãƒ‰ã®å•é¡Œä¾‹
async function badExample() {
  const user = await fetch('/api/user');
  const profile = await fetch('/api/profile');
  const settings = await fetch('/api/settings');
  
  const userData = user.json();
  const profileData = profile.json();
  const settingsData = settings.json();
  
  return { userData, profileData, settingsData };
}`,
            5: `// âŒ BAD: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãªã— + ç›´åˆ—å‡¦ç†
async function anotherBadExample(ids) {
  const results = [];
  for (const id of ids) {
    const data = await fetch(\`/api/data/\${id}\`);
    const json = await data.json();
    results.push(json);
  }
  return results;
}`,
            6: `// âœ… GOOD: é©åˆ‡ãªä¸¦åˆ—å‡¦ç†ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
async function goodExample() {
  try {
    const [userRes, profileRes, settingsRes] = await Promise.all([
      fetch('/api/user'),
      fetch('/api/profile'),
      fetch('/api/settings')
    ]);
    
    const [userData, profileData, settingsData] = await Promise.all([
      userRes.json(),
      profileRes.json(),
      settingsRes.json()
    ]);
    
    return { userData, profileData, settingsData };
  } catch (error) {
    console.error('Failed to fetch data:', error);
    throw new Error('Data fetch failed');
  }
}`,
            7: `// âŒ BAD: Promiseåœ°ç„
function promiseHell() {
  return fetch('/api/user')
    .then(response => response.json())
    .then(user => {
      return fetch(\`/api/posts/\${user.id}\`)
        .then(response => response.json())
        .then(posts => {
          return fetch(\`/api/comments/\${posts[0].id}\`)
            .then(response => response.json())
            .then(comments => {
              return { user, posts, comments };
            });
        });
    });
}`,
            8: `// âŒ BAD: æ··åœ¨ãƒ‘ã‚¿ãƒ¼ãƒ³ (async/await + .then)
async function mixedPattern() {
  const user = await fetch('/api/user').then(r => r.json());
  const posts = fetch('/api/posts').then(r => r.json());
  const comments = await fetch('/api/comments').then(r => r.json());
  
  return { user, posts: await posts, comments };
}`
        };

        function loadExample(num) {
            document.getElementById('codeInput').value = examples[num];
        }

        function analyzeCode() {
            const code = document.getElementById('codeInput').value;
            const analysis = analyzePromiseFlow(code);
            displayAnalysis(analysis);
            generateFlowDiagram(analysis);
        }

        function analyzePromiseFlow(code) {
            const issues = [];
            const suggestions = [];
            const flowSteps = [];

            // åŸºæœ¬çš„ãªè§£æãƒ‘ã‚¿ãƒ¼ãƒ³
            const awaitPattern = /await\s+([^;\n]+)/g;
            const promiseAllPattern = /Promise\.all\s*\(\s*\[([^\]]+)\]\s*\)/g;
            const tryPattern = /try\s*{[^}]*}/g;
            const fetchPattern = /fetch\s*\([^)]+\)/g;
            const thenPattern = /\.then\s*\(/g;

            let match;
            let stepCount = 0;

            // awaitæ–‡ã®è§£æ
            while ((match = awaitPattern.exec(code)) !== null) {
                stepCount++;
                flowSteps.push({
                    type: 'await',
                    content: match[1].trim(),
                    step: stepCount
                });
            }

            // ä¸¦åˆ—å‡¦ç†ã®æ¤œå‡º
            const parallelCandidates = [];
            const lines = code.split('\n');
            let consecutiveAwaits = [];

            lines.forEach((line, index) => {
                if (line.includes('await ') && !line.includes('Promise.all')) {
                    consecutiveAwaits.push({ line: line.trim(), index });
                } else if (consecutiveAwaits.length > 1) {
                    parallelCandidates.push([...consecutiveAwaits]);
                    consecutiveAwaits = [];
                } else {
                    consecutiveAwaits = [];
                }
            });

            if (consecutiveAwaits.length > 1) {
                parallelCandidates.push(consecutiveAwaits);
            }

            // å•é¡Œã¨ãƒªã‚³ãƒ¡ãƒ³ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ç”Ÿæˆ
            if (parallelCandidates.length > 0) {
                parallelCandidates.forEach(group => {
                    if (group.length >= 2) {
                        issues.push(`Lines ${group[0].index + 1}-${group[group.length - 1].index + 1}: é€£ç¶šã™ã‚‹awaitæ–‡ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ä¸¦åˆ—å®Ÿè¡Œã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚`);
                        suggestions.push(`Promise.all([${group.map(g => g.line.replace('await ', '').replace(/;$/, '')).join(', ')}])ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ä¸¦åˆ—å®Ÿè¡ŒãŒå¯èƒ½ã§ã™ã€‚`);
                    }
                });
            }

            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒã‚§ãƒƒã‚¯
            const hasTryCatch = /try\s*{[\s\S]*catch/.test(code);
            if (!hasTryCatch && /await/.test(code)) {
                issues.push('ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒä¸è¶³ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                suggestions.push('try-catchæ–‡ã‚’è¿½åŠ ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚');
            }

            // å‹å®‰å…¨æ€§ã®è­¦å‘Š - .json()ã®awaitå¿˜ã‚Œ
            const jsonWithoutAwait = [];
            const jsonPattern = /(?<!await\s+[^;\n]*?)\.json\(\)/g;
            while ((match = jsonPattern.exec(code)) !== null) {
                jsonWithoutAwait.push(match.index);
            }

            if (jsonWithoutAwait.length > 0) {
                issues.push('.json()ã®çµæœã‚’awaitã—ã¦ã„ãªã„ç®‡æ‰€ãŒã‚ã‚Šã¾ã™ã€‚');
                suggestions.push('Response.json()ã¯Promiseã‚’è¿”ã™ãŸã‚ã€awaitãŒå¿…è¦ã§ã™ã€‚');
            }

            // Promiseåœ°ç„ã®æ¤œå‡º
            const thenCount = (code.match(thenPattern) || []).length;
            if (thenCount > 2) {
                issues.push('Promise chain (.then)ãŒå¤šç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚');
                suggestions.push('async/awaitã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚');
            }

            // æ··åœ¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡º
            const hasAsync = /async\s+function/.test(code) || /=\s*async\s*\(/.test(code);
            const hasThen = thenCount > 0;
            if (hasAsync && hasThen) {
                issues.push('async/awaitã¨.thenãŒæ··åœ¨ã—ã¦ã„ã¾ã™ã€‚');
                suggestions.push('ä¸€è²«ã—ã¦async/awaitã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚');
            }

            // foræ–‡ã§ã®é€æ¬¡å®Ÿè¡Œæ¤œå‡º
            const sequentialLoop = /for\s*\([^)]*\)\s*{[^}]*await[^}]*}/g;
            if (sequentialLoop.test(code)) {
                issues.push('ãƒ«ãƒ¼ãƒ—å†…ã§ã®awaitãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ä¸¦åˆ—å‡¦ç†ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚');
                suggestions.push('Promise.all(array.map(async item => ...))ã‚’ä½¿ç”¨ã—ã¦ä¸¦åˆ—å‡¦ç†ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚');
            }

            // æœªå‡¦ç†ã®Promiseã®æ¤œå‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
            const unawaitedPromise = /(?<!await\s+)fetch\s*\([^)]+\)(?!\s*\.then)(?!\s*\.catch)/g;
            if (unawaitedPromise.test(code)) {
                issues.push('awaitã•ã‚Œã¦ã„ãªã„PromiseãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚');
                suggestions.push('Promiseã®çµæœã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€awaitã¾ãŸã¯.thenã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
            }

            return {
                issues,
                suggestions,
                flowSteps,
                parallelCandidates,
                hasErrorHandling: hasTryCatch,
                metrics: {
                    awaitCount: stepCount,
                    thenCount: thenCount,
                    parallelOpportunities: parallelCandidates.length
                }
            };
        }

        function displayAnalysis(analysis) {
            const issuesContent = document.getElementById('issuesContent');
            const metricsContent = document.getElementById('metricsContent');

            let issuesHtml = '';
            let metricsHtml = '';

            // Issues and suggestions
            if (analysis.issues.length > 0) {
                analysis.issues.forEach(issue => {
                    issuesHtml += `<div class="warning">âš ï¸ ${issue}</div>`;
                });
            }

            if (analysis.suggestions.length > 0) {
                analysis.suggestions.forEach(suggestion => {
                    issuesHtml += `<div class="suggestion">ğŸ’¡ ${suggestion}</div>`;
                });
            }

            if (analysis.issues.length === 0 && analysis.suggestions.length === 0) {
                issuesHtml = '<div class="suggestion">âœ… ã‚³ãƒ¼ãƒ‰ã«æ˜ã‚‰ã‹ãªå•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
            }

            // Metrics
            if (analysis.metrics) {
                metricsHtml += `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: #1a1a1a; padding: 15px; border-radius: 4px; border: 1px solid #404040;">
                            <div style="color: #4a9eff; font-size: 24px; font-weight: bold;">${analysis.metrics.awaitCount}</div>
                            <div style="color: #ccc; font-size: 14px;">Await Statements</div>
                        </div>
                        <div style="background: #1a1a1a; padding: 15px; border-radius: 4px; border: 1px solid #404040;">
                            <div style="color: ${analysis.metrics.thenCount > 2 ? '#ffa500' : '#4a9eff'}; font-size: 24px; font-weight: bold;">${analysis.metrics.thenCount}</div>
                            <div style="color: #ccc; font-size: 14px;">.then() Chains</div>
                        </div>
                        <div style="background: #1a1a1a; padding: 15px; border-radius: 4px; border: 1px solid #404040;">
                            <div style="color: ${analysis.metrics.parallelOpportunities > 0 ? '#ffa500' : '#4a9eff'}; font-size: 24px; font-weight: bold;">${analysis.metrics.parallelOpportunities}</div>
                            <div style="color: #ccc; font-size: 14px;">Parallel Opportunities</div>
                        </div>
                        <div style="background: #1a1a1a; padding: 15px; border-radius: 4px; border: 1px solid #404040;">
                            <div style="color: ${analysis.hasErrorHandling ? '#4caf50' : '#f44336'}; font-size: 24px; font-weight: bold;">${analysis.hasErrorHandling ? 'âœ“' : 'âœ—'}</div>
                            <div style="color: #ccc; font-size: 14px;">Error Handling</div>
                        </div>
                    </div>
                `;
            }

            issuesContent.innerHTML = issuesHtml;
            metricsContent.innerHTML = metricsHtml;
        }
        // ç‰¹æ®Šæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦Mermaidãƒ©ãƒ™ãƒ«ã‚’ç”Ÿæˆ
        function escapeMermaidLabel(text) {
            return text
                .replace(/[`\[\]{}|"]/g, '') // ç‰¹æ®Šæ–‡å­—ã‚’å‰Šé™¤
                .replace(/\$\{[^}]*\}/g, '${...}') // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«ã‚’ç°¡ç•¥åŒ–
                .substring(0, 30); // é•·ã•åˆ¶é™
        }
        function generateFlowDiagram(analysis) {
            let mermaidCode = 'graph TD\n';
            mermaidCode += '    Start([Function Start])\n';

            let currentNode = 'Start';
            let nodeCount = 1;

            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è¡¨ç¾
            if (analysis.hasErrorHandling) {
                mermaidCode += '    TryBlock{Try Block}\n';
                mermaidCode += '    Start --> TryBlock\n';
                currentNode = 'TryBlock';
            }

            // ãƒ•ãƒ­ãƒ¼ã‚¹ãƒ†ãƒƒãƒ—ã®ç”Ÿæˆ
            analysis.flowSteps.forEach((step, index) => {
                const nodeName = `Step${nodeCount}`;
                const stepLabel = escapeMermaidLabel(step.content);
                const nodeLabel = stepLabel.length > 30 - 2 ?
                    stepLabel.substring(0, 30 - 2) + '...' :
                    stepLabel;

                if (step.type === 'await') {
                    mermaidCode += `    ${nodeName}["await ${nodeLabel}"]\n`;
                }

                mermaidCode += `    ${currentNode} --> ${nodeName}\n`;
                currentNode = nodeName;
                nodeCount++;
            });

            // ä¸¦åˆ—å‡¦ç†ã®ææ¡ˆ
            if (analysis.parallelCandidates.length > 0) {
                analysis.parallelCandidates.forEach((group, groupIndex) => {
                    if (group.length >= 2) {
                        const parallelNode = `Parallel${groupIndex}`;
                        mermaidCode += `    ${parallelNode}{å¯èƒ½ãªä¸¦åˆ—å‡¦ç†}\n`;
                        mermaidCode += `    ${parallelNode} -.-> |ææ¡ˆ| ${currentNode}\n`;
                    }
                });
            }

            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            if (analysis.hasErrorHandling) {
                mermaidCode += '    ErrorNode[Error Handling]\n';
                mermaidCode += '    TryBlock -.-> |catch| ErrorNode\n';
            }

            mermaidCode += `    ${currentNode} --> End([Function End])\n`;

            // ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
            mermaidCode += `
    classDef awaitNode fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef parallelNode fill:#fff3e0,stroke:#f57c00,stroke-width:2px,stroke-dasharray: 5 5
    classDef errorNode fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    `;

            const diagramElement = document.getElementById('flowDiagram');
            diagramElement.innerHTML = '';

            mermaid.render('promiseFlowDiagram', mermaidCode).then(({ svg }) => {
                diagramElement.innerHTML = svg;
            }).catch(err => {
                diagramElement.innerHTML = `<p>å›³ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}</p><pre>${mermaidCode}</pre>`;
            });
        }

        // åˆæœŸåˆ†æ
        window.onload = () => {
            analyzeCode();
        };
    </script>
</body>

</html>