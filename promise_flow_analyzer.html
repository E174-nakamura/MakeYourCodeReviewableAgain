<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promise Flow Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .input-panel,
        .output-panel {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #404040;
        }

        .input-panel {
            display: flex;
            flex-direction: column;
        }

        h2 {
            margin-top: 0;
            color: #4a9eff;
            border-bottom: 2px solid #4a9eff;
            padding-bottom: 10px;
        }

        textarea {
            flex: 1;
            background: #1a1a1a;
            color: #e0e0e0;
            border: 1px solid #404040;
            border-radius: 4px;
            padding: 15px;
            font-family: inherit;
            font-size: 14px;
            resize: none;
            outline: none;
        }

        textarea:focus {
            border-color: #4a9eff;
        }

        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 15px;
            transition: background 0.2s;
        }

        button:hover {
            background: #357abd;
        }

        .analysis-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 4px;
            border: 1px solid #404040;
        }

        .analysis-section h3 {
            margin-top: 0;
            color: #ffa500;
        }

        .warning {
            background: #4a2c00;
            border-left: 4px solid #ffa500;
            padding: 10px;
            margin: 10px 0;
        }

        .suggestion {
            background: #003d4a;
            border-left: 4px solid #00bcd4;
            padding: 10px;
            margin: 10px 0;
        }

        .mermaid {
            background: white;
            border-radius: 4px;
            padding: 20px;
            margin: 15px 0;
        }

        .examples {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .example-btn {
            background: #404040;
            padding: 8px 12px;
            font-size: 12px;
        }

        .example-btn:hover {
            background: #505050;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="input-panel">
            <h2>üìù JavaScript/TypeScript Code</h2>
            <div class="examples">
                <button class="example-btn" onclick="loadExample(1)">Basic</button>
                <button class="example-btn" onclick="loadExample(2)">Parallel</button>
                <button class="example-btn" onclick="loadExample(3)">Complex</button>
                <button class="example-btn" onclick="loadExample(4)" style="background: #d32f2f;">‚ùå Bad 1</button>
                <button class="example-btn" onclick="loadExample(5)" style="background: #d32f2f;">‚ùå Bad 2</button>
                <button class="example-btn" onclick="loadExample(6)" style="background: #2e7d32;">‚úÖ Good</button>
                <button class="example-btn" onclick="loadExample(7)" style="background: #d32f2f;">‚ùå Hell</button>
                <button class="example-btn" onclick="loadExample(8)" style="background: #d32f2f;">‚ùå Mixed</button>
            </div>
            <textarea id="codeInput" placeholder="async function example() {
  const data = await fetch('/api/data');
  const result = await data.json();
  return result;
}">async function fetchUserData(userId) {
  try {
    const user = await fetch(`/api/users/${userId}`);
    const userData = await user.json();
    
    const posts = await fetch(`/api/users/${userId}/posts`);
    const postsData = await posts.json();
    
    return { user: userData, posts: postsData };
  } catch (error) {
    console.error('Error:', error);
    throw error;
  }
}</textarea>
            <button onclick="analyzeCode()">üîç Analyze Promise Flow</button>
        </div>

        <div class="output-panel">
            <h2>üìä Promise Flow Analysis</h2>

            <div class="analysis-section" id="issues">
                <h3>‚ö†Ô∏è Issues & Suggestions</h3>
                <div id="issuesContent">ÂàÜÊûêÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</div>
            </div>

            <div class="analysis-section" id="metrics">
                <h3>üìà Code Metrics</h3>
                <div id="metricsContent"></div>
            </div>

            <div class="analysis-section">
                <h3>üó∫Ô∏è Promise Flow Diagram</h3>
                <div id="flowDiagram"></div>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: false,
            theme: 'base',
            themeVariables: {
                primaryColor: '#4a9eff',
                primaryTextColor: '#000',
                primaryBorderColor: '#357abd',
                lineColor: '#666',
                secondaryColor: '#ffa500',
                tertiaryColor: '#e0e0e0'
            }
        });

        const examples = {
            1: `async function fetchUserData(userId) {
  try {
    const user = await fetch(\`/api/users/\${userId}\`);
    const userData = await user.json();
    
    const posts = await fetch(\`/api/users/\${userId}/posts\`);
    const postsData = await posts.json();
    
    return { user: userData, posts: postsData };
  } catch (error) {
    console.error('Error:', error);
    throw error;
  }
}`,
            2: `async function processData() {
  const data1 = fetch('/api/data1');
  const data2 = fetch('/api/data2');
  const data3 = fetch('/api/data3');
  
  const result1 = await data1.json();
  const result2 = await data2.json();
  const result3 = await data3.json();
  
  return [result1, result2, result3];
}`,
            3: `async function complexFlow(id) {
  const config = await getConfig();
  
  if (config.useCache) {
    const cached = await getFromCache(id);
    if (cached) return cached;
  }
  
  const [userData, preferences] = await Promise.all([
    fetchUser(id),
    fetchPreferences(id)
  ]);
  
  const enrichedData = await enrichUserData(userData, preferences);
  
  if (config.useCache) {
    await saveToCache(id, enrichedData);
  }
  
  return enrichedData;
}`,
            // „ÉÜ„Çπ„Éà„Ç±„Éº„ÇπÁî®„ÅÆËøΩÂä†‰æã
            4: `// ‚ùå BAD: ÂÖ∏ÂûãÁöÑ„Å™AIÁîüÊàê„Ç≥„Éº„Éâ„ÅÆÂïèÈ°å‰æã
async function badExample() {
  const user = await fetch('/api/user');
  const profile = await fetch('/api/profile');
  const settings = await fetch('/api/settings');
  
  const userData = user.json();
  const profileData = profile.json();
  const settingsData = settings.json();
  
  return { userData, profileData, settingsData };
}`,
            5: `// ‚ùå BAD: „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„Å™„Åó + Áõ¥ÂàóÂá¶ÁêÜ
async function anotherBadExample(ids) {
  const results = [];
  for (const id of ids) {
    const data = await fetch(\`/api/data/\${id}\`);
    const json = await data.json();
    results.push(json);
  }
  return results;
}`,
            6: `// ‚úÖ GOOD: ÈÅ©Âàá„Å™‰∏¶ÂàóÂá¶ÁêÜ„Å®„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
async function goodExample() {
  try {
    const [userRes, profileRes, settingsRes] = await Promise.all([
      fetch('/api/user'),
      fetch('/api/profile'),
      fetch('/api/settings')
    ]);
    
    const [userData, profileData, settingsData] = await Promise.all([
      userRes.json(),
      profileRes.json(),
      settingsRes.json()
    ]);
    
    return { userData, profileData, settingsData };
  } catch (error) {
    console.error('Failed to fetch data:', error);
    throw new Error('Data fetch failed');
  }
}`,
            7: `// ‚ùå BAD: PromiseÂú∞ÁçÑ
function promiseHell() {
  return fetch('/api/user')
    .then(response => response.json())
    .then(user => {
      return fetch(\`/api/posts/\${user.id}\`)
        .then(response => response.json())
        .then(posts => {
          return fetch(\`/api/comments/\${posts[0].id}\`)
            .then(response => response.json())
            .then(comments => {
              return { user, posts, comments };
            });
        });
    });
}`,
            8: `// ‚ùå BAD: Ê∑∑Âú®„Éë„Çø„Éº„É≥ (async/await + .then)
async function mixedPattern() {
  const user = await fetch('/api/user').then(r => r.json());
  const posts = fetch('/api/posts').then(r => r.json());
  const comments = await fetch('/api/comments').then(r => r.json());
  
  return { user, posts: await posts, comments };
}`
        };

        function loadExample(num) {
            document.getElementById('codeInput').value = examples[num];
        }

        function analyzeCode() {
            const code = document.getElementById('codeInput').value;
            const analysis = analyzePromiseFlow(code);
            displayAnalysis(analysis);
            generateFlowDiagram(analysis);
        }

        function analyzePromiseFlow(code) {
            const issues = [];
            const suggestions = [];
            const flowSteps = [];

            // Âü∫Êú¨ÁöÑ„Å™Ëß£Êûê„Éë„Çø„Éº„É≥
            const awaitPattern = /await\s+([^;\n]+)/g;
            const promiseAllPattern = /Promise\.all\s*\(\s*\[([^\]]+)\]\s*\)/g;
            const tryPattern = /try\s*{[^}]*}/g;
            const fetchPattern = /fetch\s*\([^)]+\)/g;
            const thenPattern = /\.then\s*\(/g;

            let match;
            let stepCount = 0;

            // awaitÊñá„ÅÆËß£Êûê
            while ((match = awaitPattern.exec(code)) !== null) {
                stepCount++;
                flowSteps.push({
                    type: 'await',
                    content: match[1].trim(),
                    step: stepCount
                });
            }

            // ‰∏¶ÂàóÂá¶ÁêÜ„ÅÆÊ§úÂá∫
            const parallelCandidates = [];
            const lines = code.split('\n');
            let consecutiveAwaits = [];

            lines.forEach((line, index) => {
                if (line.includes('await ') && !line.includes('Promise.all')) {
                    consecutiveAwaits.push({ line: line.trim(), index });
                } else if (consecutiveAwaits.length > 1) {
                    parallelCandidates.push([...consecutiveAwaits]);
                    consecutiveAwaits = [];
                } else {
                    consecutiveAwaits = [];
                }
            });

            if (consecutiveAwaits.length > 1) {
                parallelCandidates.push(consecutiveAwaits);
            }

            // ÂïèÈ°å„Å®„É™„Ç≥„É°„É≥„Éá„Éº„Ç∑„Éß„É≥„ÅÆÁîüÊàê
            if (parallelCandidates.length > 0) {
                parallelCandidates.forEach(group => {
                    if (group.length >= 2) {
                        issues.push(`Lines ${group[0].index + 1}-${group[group.length - 1].index + 1}: ÈÄ£Á∂ö„Åô„ÇãawaitÊñá„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü„ÄÇ‰∏¶ÂàóÂÆüË°å„ÇíÊ§úË®é„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                        suggestions.push(`Promise.all([${group.map(g => g.line.replace('await ', '').replace(/;$/, '')).join(', ')}])„Çí‰ΩøÁî®„Åô„Çã„Åì„Å®„Åß‰∏¶ÂàóÂÆüË°å„ÅåÂèØËÉΩ„Åß„Åô„ÄÇ`);
                    }
                });
            }

            // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„ÉÅ„Çß„ÉÉ„ÇØ
            const hasTryCatch = /try\s*{[\s\S]*catch/.test(code);
            if (!hasTryCatch && /await/.test(code)) {
                issues.push('„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ');
                suggestions.push('try-catchÊñá„ÇíËøΩÂä†„Åó„Å¶„Ç®„É©„Éº„ÇíÈÅ©Âàá„Å´Âá¶ÁêÜ„Åô„Çã„Åì„Å®„ÇíÊé®Â•®„Åó„Åæ„Åô„ÄÇ');
            }

            // ÂûãÂÆâÂÖ®ÊÄß„ÅÆË≠¶Âëä - .json()„ÅÆawaitÂøò„Çå
            const jsonWithoutAwait = [];
            const jsonPattern = /(?<!await\s+[^;\n]*?)\.json\(\)/g;
            while ((match = jsonPattern.exec(code)) !== null) {
                jsonWithoutAwait.push(match.index);
            }

            if (jsonWithoutAwait.length > 0) {
                issues.push('.json()„ÅÆÁµêÊûú„Çíawait„Åó„Å¶„ÅÑ„Å™„ÅÑÁÆáÊâÄ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ');
                suggestions.push('Response.json()„ÅØPromise„ÇíËøî„Åô„Åü„ÇÅ„ÄÅawait„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
            }

            // PromiseÂú∞ÁçÑ„ÅÆÊ§úÂá∫
            const thenCount = (code.match(thenPattern) || []).length;
            if (thenCount > 2) {
                issues.push('Promise chain (.then)„ÅåÂ§öÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
                suggestions.push('async/await„Çí‰ΩøÁî®„Åó„Å¶„Ç≥„Éº„Éâ„ÅÆÂèØË™≠ÊÄß„ÇíÂêë‰∏ä„Åï„Åõ„Çã„Åì„Å®„ÇíÊé®Â•®„Åó„Åæ„Åô„ÄÇ');
            }

            // Ê∑∑Âú®„Éë„Çø„Éº„É≥„ÅÆÊ§úÂá∫
            const hasAsync = /async\s+function/.test(code) || /=\s*async\s*\(/.test(code);
            const hasThen = thenCount > 0;
            if (hasAsync && hasThen) {
                issues.push('async/await„Å®.then„ÅåÊ∑∑Âú®„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ');
                suggestions.push('‰∏ÄË≤´„Åó„Å¶async/await„Çí‰ΩøÁî®„Åô„Çã„Åì„Å®„ÇíÊé®Â•®„Åó„Åæ„Åô„ÄÇ');
            }

            // forÊñá„Åß„ÅÆÈÄêÊ¨°ÂÆüË°åÊ§úÂá∫
            const sequentialLoop = /for\s*\([^)]*\)\s*{[^}]*await[^}]*}/g;
            if (sequentialLoop.test(code)) {
                issues.push('„É´„Éº„ÉóÂÜÖ„Åß„ÅÆawait„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü„ÄÇ‰∏¶ÂàóÂá¶ÁêÜ„ÇíÊ§úË®é„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                suggestions.push('Promise.all(array.map(async item => ...))„Çí‰ΩøÁî®„Åó„Å¶‰∏¶ÂàóÂá¶ÁêÜ„Å´Â§âÊõ¥„Åô„Çã„Åì„Å®„ÇíÊé®Â•®„Åó„Åæ„Åô„ÄÇ');
            }

            // Êú™Âá¶ÁêÜ„ÅÆPromise„ÅÆÊ§úÂá∫ÔºàÁ∞°ÊòìÁâàÔºâ
            const unawaitedPromise = /(?<!await\s+)fetch\s*\([^)]+\)(?!\s*\.then)(?!\s*\.catch)/g;
            if (unawaitedPromise.test(code)) {
                issues.push('await„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑPromise„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
                suggestions.push('Promise„ÅÆÁµêÊûú„Çí‰ΩøÁî®„Åô„ÇãÂ†¥Âêà„ÅØ„ÄÅawait„Åæ„Åü„ÅØ.then„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }

            return {
                issues,
                suggestions,
                flowSteps,
                parallelCandidates,
                hasErrorHandling: hasTryCatch,
                metrics: {
                    awaitCount: stepCount,
                    thenCount: thenCount,
                    parallelOpportunities: parallelCandidates.length
                }
            };
        }

        function displayAnalysis(analysis) {
            const issuesContent = document.getElementById('issuesContent');
            const metricsContent = document.getElementById('metricsContent');

            let issuesHtml = '';
            let metricsHtml = '';

            // Issues and suggestions
            if (analysis.issues.length > 0) {
                analysis.issues.forEach(issue => {
                    issuesHtml += `<div class="warning">‚ö†Ô∏è ${issue}</div>`;
                });
            }

            if (analysis.suggestions.length > 0) {
                analysis.suggestions.forEach(suggestion => {
                    issuesHtml += `<div class="suggestion">üí° ${suggestion}</div>`;
                });
            }

            if (analysis.issues.length === 0 && analysis.suggestions.length === 0) {
                issuesHtml = '<div class="suggestion">‚úÖ „Ç≥„Éº„Éâ„Å´Êòé„Çâ„Åã„Å™ÂïèÈ°å„ÅØÊ§úÂá∫„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</div>';
            }

            // Metrics
            if (analysis.metrics) {
                metricsHtml += `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: #1a1a1a; padding: 15px; border-radius: 4px; border: 1px solid #404040;">
                            <div style="color: #4a9eff; font-size: 24px; font-weight: bold;">${analysis.metrics.awaitCount}</div>
                            <div style="color: #ccc; font-size: 14px;">Await Statements</div>
                        </div>
                        <div style="background: #1a1a1a; padding: 15px; border-radius: 4px; border: 1px solid #404040;">
                            <div style="color: ${analysis.metrics.thenCount > 2 ? '#ffa500' : '#4a9eff'}; font-size: 24px; font-weight: bold;">${analysis.metrics.thenCount}</div>
                            <div style="color: #ccc; font-size: 14px;">.then() Chains</div>
                        </div>
                        <div style="background: #1a1a1a; padding: 15px; border-radius: 4px; border: 1px solid #404040;">
                            <div style="color: ${analysis.metrics.parallelOpportunities > 0 ? '#ffa500' : '#4a9eff'}; font-size: 24px; font-weight: bold;">${analysis.metrics.parallelOpportunities}</div>
                            <div style="color: #ccc; font-size: 14px;">Parallel Opportunities</div>
                        </div>
                        <div style="background: #1a1a1a; padding: 15px; border-radius: 4px; border: 1px solid #404040;">
                            <div style="color: ${analysis.hasErrorHandling ? '#4caf50' : '#f44336'}; font-size: 24px; font-weight: bold;">${analysis.hasErrorHandling ? '‚úì' : '‚úó'}</div>
                            <div style="color: #ccc; font-size: 14px;">Error Handling</div>
                        </div>
                    </div>
                `;
            }

            issuesContent.innerHTML = issuesHtml;
            metricsContent.innerHTML = metricsHtml;
        }
        // ÁâπÊÆäÊñáÂ≠ó„Çí„Ç®„Çπ„Ç±„Éº„Éó„Åó„Å¶Mermaid„É©„Éô„É´„ÇíÁîüÊàê
        function escapeMermaidLabel(text) {
            return text
                .replace(/[`\[\]{}|"]/g, '') // ÁâπÊÆäÊñáÂ≠ó„ÇíÂâäÈô§
                .replace(/\$\{[^}]*\}/g, '${...}') // „ÉÜ„É≥„Éó„É¨„Éº„Éà„É™„ÉÜ„É©„É´„ÇíÁ∞°Áï•Âåñ
                .substring(0, 30); // Èï∑„ÅïÂà∂Èôê
        }
        function generateFlowDiagram(analysis) {
            let mermaidCode = 'graph TD\n';
            mermaidCode += '    Start([Function Start])\n';

            let currentNode = 'Start';
            let nodeCount = 1;

            // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„ÅÆË°®Áèæ
            if (analysis.hasErrorHandling) {
                mermaidCode += '    TryBlock{Try Block}\n';
                mermaidCode += '    Start --> TryBlock\n';
                currentNode = 'TryBlock';
            }

            // „Éï„É≠„Éº„Çπ„ÉÜ„ÉÉ„Éó„ÅÆÁîüÊàê
            analysis.flowSteps.forEach((step, index) => {
                const nodeName = `Step${nodeCount}`;
                const stepLabel = escapeMermaidLabel(step.content);
                const nodeLabel = stepLabel.length > 30 - 2 ?
                    stepLabel.substring(0, 30 - 2) + '...' :
                    stepLabel;

                if (step.type === 'await') {
                    mermaidCode += `    ${nodeName}["await ${nodeLabel}"]\n`;
                }

                mermaidCode += `    ${currentNode} --> ${nodeName}\n`;
                currentNode = nodeName;
                nodeCount++;
            });

            // ‰∏¶ÂàóÂá¶ÁêÜ„ÅÆÊèêÊ°à
            if (analysis.parallelCandidates.length > 0) {
                analysis.parallelCandidates.forEach((group, groupIndex) => {
                    if (group.length >= 2) {
                        const parallelNode = `Parallel${groupIndex}`;
                        mermaidCode += `    ${parallelNode}{ÂèØËÉΩ„Å™‰∏¶ÂàóÂá¶ÁêÜ}\n`;
                        mermaidCode += `    ${parallelNode} -.-> |ÊèêÊ°à| ${currentNode}\n`;
                    }
                });
            }

            // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
            if (analysis.hasErrorHandling) {
                mermaidCode += '    ErrorNode[Error Handling]\n';
                mermaidCode += '    TryBlock -.-> |catch| ErrorNode\n';
            }

            mermaidCode += `    ${currentNode} --> End([Function End])\n`;

            // „Çπ„Çø„Ç§„É™„É≥„Ç∞
            mermaidCode += `
    classDef awaitNode fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef parallelNode fill:#fff3e0,stroke:#f57c00,stroke-width:2px,stroke-dasharray: 5 5
    classDef errorNode fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    `;

            const diagramElement = document.getElementById('flowDiagram');
            diagramElement.innerHTML = '';

            mermaid.render('promiseFlowDiagram', mermaidCode).then(({ svg }) => {
                diagramElement.innerHTML = svg;
            }).catch(err => {
                diagramElement.innerHTML = `<p>Âõ≥„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${err.message}</p><pre>${mermaidCode}</pre>`;
            });
        }

        // ÂàùÊúüÂàÜÊûê
        window.onload = () => {
            analyzeCode();
        };
    </script>
</body>

</html>